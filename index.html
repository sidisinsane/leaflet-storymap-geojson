<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Leaflet Storymap template</title>
<!-- <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /> -->
<link rel="stylesheet" href="http://cdn.jsdelivr.net/leaflet/0.7.3/leaflet.css" />
<script src="http://cdn.jsdelivr.net/leaflet/0.7.3/leaflet.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src='https://code.jquery.com/jquery-1.11.3.min.js'></script>
<!-- if using Mapbox account -->
<script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
<!-- load from local directory -->
<script src="leaflet-omnivore.min.js"></script>
<link href="custom.css" rel="stylesheet" type="text/css">
</head>
<body>


<div id="map"></div>

<div id="markerinfo">
    <div id="markerinfo2"><div class="cycle"><a href="index.html" class="next1" onclick="next()">NEXT &gt;&gt;</a></div><iframe src="slides/text0.html" id="iframe" frameborder="0"></iframe></div>
</div>

<script>

  //Currently requires Mapbox Access Token (from jackdougherty - insert your own)
  L.mapbox.accessToken = 'pk.eyJ1IjoiamFja2RvdWdoZXJ0eSIsImEiOiJxMi11TGlzIn0.ydUTGpMKcADi7fKPxy0GVA';

  //set up map; see center and zoom level in slide0
  var map = L.map('map');

  // can revert  to light_nolabels if inserting a different label overlay
  new L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
  		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
	}).addTo(map);

  // customize source link to your GitHub repo
  map.attributionControl
  .setPrefix('View <a href="http://github.com/jackdougherty/leaflet-map-story">code on GitHub</a>, created with <a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>');

  //TESTING Flickr photo overlay (items display, but button is not working)
  //Use Flickr API explorer to obtain correct endpoint and insert your own API key
  //Photos.search currently works, but error with photosets.getPhotos
  //https://www.flickr.com/services/api/explore/flickr.photos.search
  //https://www.flickr.com/services/api/explore/flickr.photosets.getPhotos

  var flickrURL = "https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=25dcc9a8c7410551dcb0af48c778bde5&user_id=56513965%40N06&tags=bikemap&extras=geo%2Curl_t%2Curl_m%2Ctitle&format=json&nojsoncallback=1";
  //This returns error
  //var flickrURL = "https://api.flickr.com/services/rest/?method=flickr.photosets.getPhotos&api_key=25dcc9a8c7410551dcb0af48c778bde5&photoset_id=72157646371103550&extras=geo%2Curl_t%2Curl_m&format=json&nojsoncallback=1";
  var popupHTML = function(photo){
    var result = "";
                result = '<strong>'+photo.title+'</strong><br>';
                result += '<a href="'+photo.url_m+'" target="_blank">';
                result += '<img src="'+photo.url_t+'"></a>';      //can change to url_m if desired, but frame needs work
                result += '<p><small>click to enlarge</small></p>';
                return result;
  }
  // TEST #1 trying to modify this $.ajax flickr function that originally worked in bikemapcode
  $.ajax({
    url: flickrURL,
    dataType: 'json',
    success: function(data){
      for (var i = 0; i < data.photos.photo.length; i++){
        var photo_obj = data.photos.photo[i];
        var photo_icon = L.icon(
          {iconUrl: photo_obj.url_t,
          iconSize: [photo_obj.width_t * 0.5, photo_obj.height_t * 0.5]}  //reduces thumbnails 50%
        );

        var flickrPhotos = new L.marker([photo_obj.latitude, photo_obj.longitude], {icon: photo_icon})
        .bindPopup(popupHTML(photo_obj)).addTo(map);
      }
    }
  });







  //Array to hold the layers for each slide in the story
  var mapLayers = new Array();

  // This keeps track of our progress through the story.
  var storyProgress = new Object();

  var startStory = function(storySlides, start, finish) {
    current = storySlides[start];
    storyProgress.markers = storySlides
    storyProgress.progress = start;
    storyProgress.beginning = start;
    storyProgress.end = finish;
    slideZoom(current);
  }

  function slideParam(slideContent, lati, longi, zoomStory, slideLayer, slideNumber, layerType) {
      this.slideContent = slideContent;
      this.zoomStory = zoomStory;
      this.slideLayer = slideLayer;
      this.lati = lati;
      this.longi = longi;
      this.slideNumber = slideNumber;
      this.layerType = layerType;
  }

  function slideZoom(current) {
      map.setView(new L.LatLng(current.lati, current.longi), current.zoomStory);
      if(mapLayers[0]) {
            map.removeLayer(mapLayers[0]);
            mapLayers.splice(0,1);
          }
      if(current.layerType=="none") {
        console.log("none");
      }
      // loads geojson from local directory, but requires L.mapbox.featureLayer and access code
      // see unsuccess attempts to replace this code below
      if(current.layerType=="geoj") {
        var gLayer = L.mapbox.featureLayer()
          .loadURL(current.slideLayer)
          .addTo(map);
        mapLayers.push(gLayer);
      }
      // TESTING replacement: variation on using L.geoJson with var = data in local js file; hence geov
      if(current.layerType=="geov") {
        var gLayer = L.geoJson(current.slideLayer).addTo(map);
        mapLayers.push(gLayer);
      }
      // Unsuccessful L.mapbox.featureLayer replacement using L.geoJson with var = data in local js file
      // if(current.layerType=="geoj") {
      //   var gLayer = L.geoJson(data)
      //     .loadURL(current.slideLayer)
      //     .addTo(map);
      //   mapLayers.push(gLayer);
      // }
      // Unsuccessful L.mapbox.featureLayer replacement using Leaflet-Omnivore
      // if(current.layerType=="geoj") {
      //   var gLayer = omnivore.geojson()
      //     .loadURL(current.slideLayer)
      //     .addTo(map);
      //   mapLayers.push(gLayer);
      // }
      // Another Unsuccessful L.mapbox.featureLayer replacement using Leaflet-Omnivore
      // if(current.layerType=="geoj") {
      //     var gLayer = omnivore.geoJson(current.sliderLayer)
      //       .addTo(map);
      //     mapLayers.push(gLayer);
      // }
      // rewrote as L.tileLayer http://leafletjs.com/reference.html#tilelayer
      if(current.layerType=="tile") {
          var tLayer = L.tileLayer(current.slideLayer).addTo(map);
          mapLayers.push(tLayer);
      }
      slideDisplay(current);
  };

  var slideDisplay = function(current){
      if (current.slideNumber == 0) {
          var info = '<div class="cycle">' +
              '<a href="#" class="next1" onclick="next()">NEXT >></a>' + '</div>' + '<iframe src="slides/text0.html" id="iframe" frameborder="0"></iframe>';
      }
      else if (current.slideNumber == 99) {
          var info ='<div class="cycle">' +
              '<a href="#" class="prev" onclick="prev()"><< PREVIOUS</a>' + '</div>' + current.slideContent;
      }
      else {
          var info = '<div class="cycle">' + '<a href="#" class="prev" onclick="prev()"><< PREVIOUS</a>' +
              '<a href="#" class="next" onclick="next()">NEXT >></a>' + '</div>' + current.slideContent;
      }

      document.getElementById('markerinfo2').innerHTML = info;
  }

  // Next - get the progress from storyProgress, update the current value, and update the display.
  function next() {
      if (storyProgress.progress < storyProgress.end - 1) {
          storyProgress.progress = storyProgress.progress + 1;
          slideZoom(storyProgress.markers[storyProgress.progress]);
      }
      else if (storyProgress.progress = storyProgress.end - 1) {
          storyProgress.progress = storyProgress.progress + 1;
          slideZoom(storyProgress.markers[storyProgress.progress]);
      }
      else if (storyProgress.progress = storyProgress.end) {
          storyProgress.progress = storyProgress.progress;
      }
      else {
          storyProgress.progress = storyProgress.beginning;
          slideZoom(storyProgress.markers[storyProgress.progress]);
      }
      console.log(storyProgress.progress);
  }

  function prev() {
     if (storyProgress.progress > storyProgress.beginning & storyProgress.progress < storyProgress.end) {
          storyProgress.progress = storyProgress.progress - 1;
          slideZoom(storyProgress.markers[storyProgress.progress]);
      }
      else if (storyProgress.progress = storyProgress.beginning) {
          storyProgress.progress = storyProgress.progress;
          //center(storyProgress.markers[storyProgress.progress]);
      }
      else if (storyProgress.progress = storyProgress.end) {
          storyProgress.progress = storyProgress.end - 1;
          slideZoom(storyProgress.markers[storyProgress.progress]);
      }
      console.log(storyProgress);
  }

  // Create an HTML file and associated entry to display text of each slide
  var slideContent = ['<iframe src="slides/text0.html" id="iframe" frameborder="0"></iframe>',  '<iframe src="slides/text1.html" id="iframe" frameborder="0"></iframe>', '<iframe src="slides/text2.html" id="iframe" frameborder="0"></iframe>', '<iframe src="slides/text3.html" id="iframe" frameborder="0"></iframe>', '<iframe src="slides/text4.html" id="iframe" frameborder="0"></iframe>', '<iframe src="slides/text5.html" id="iframe" frameborder="0"></iframe>'];

  // Create a variable for each slide. To omit slideLayer spatial content, use empty quote marks ""
  var slide0 = new slideParam(slideContent[0], 41.78, -72.69, 10, "slides/borders1869.geojson", 0, "geoj");
  var slide1 = new slideParam(slideContent[1], 41.76, -72.69, 12, "slides/hartford.geojson", 1, "geoj");
  var slide2 = new slideParam(slideContent[2], 41.74, -72.65, 13, "slides/test-markers.geojson", 2,  "geoj");
  var slide3 = new slideParam(slideContent[3], 41.67, -72.7, 12, "slides/test-polygon.geojson", 3, "geoj");
  var slide4 = new slideParam(slideContent[4], 41.76, -72.67, 12, "http://mapwarper.net/maps/tile/10115/{z}/{x}/{y}.png", 4, "tile");
  var slide5 = new slideParam(slideContent[5], 41.78, -72.7, 14, "http://mapwarper.net/maps/tile/10115/{z}/{x}/{y}.png", 99, "tile");

  // Create an entry for each slide, and range must match slides (e.g. 0, 5)
  var allSlides = [slide0, slide1, slide2, slide3, slide4, slide5];
  startStory(allSlides, 0, 5)

  </script>

</body>
</html>
